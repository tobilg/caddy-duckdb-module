#!/usr/bin/env bash
#
# Pre-commit hook for Caddy DuckDB Extension
#
# Install this hook by running:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use make:
#   make install-hooks
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

echo "Running pre-commit checks..."
echo ""

# Check if there are staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo -e "${YELLOW}No Go files staged, skipping checks.${NC}"
    exit 0
fi

# 1. Check formatting
echo "Checking formatting..."
UNFORMATTED=$(gofmt -l $STAGED_GO_FILES)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${RED}The following files are not formatted:${NC}"
    echo "$UNFORMATTED"
    echo ""
    echo -e "${YELLOW}Run 'make fmt' to fix.${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Formatting OK${NC}"

# 2. Run go vet
echo "Running go vet..."
if ! go vet ./... 2>&1; then
    echo -e "${RED}go vet found issues.${NC}"
    exit 1
fi
echo -e "${GREEN}✓ go vet OK${NC}"

# 3. Check for common issues in staged files
echo "Checking for common issues..."

# Check for fmt.Println (should use logger)
if grep -n 'fmt.Println' $STAGED_GO_FILES 2>/dev/null; then
    echo -e "${YELLOW}Warning: Found fmt.Println - consider using structured logging.${NC}"
fi

# Check for TODO/FIXME comments
TODOS=$(grep -n 'TODO\|FIXME' $STAGED_GO_FILES 2>/dev/null || true)
if [ -n "$TODOS" ]; then
    echo -e "${YELLOW}Note: Found TODO/FIXME comments:${NC}"
    echo "$TODOS"
fi

echo ""
echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
exit 0
